<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>我的优惠券</title>
		<link rel="stylesheet" type="text/css" href="../css/ui.css">
		<link rel="stylesheet" type="text/css" href="../css/lib/CSSRESET.css">
		<link rel="stylesheet" type="text/css" href="../css/common2.css">
		<link rel="stylesheet" type="text/css" href="../css/index.css">
		
		<link rel="stylesheet" href="../css/lib/huimin.css">
		<script src="../js/base.js"></script>
		<style>
			[v-cloak] {
				display: none;
			}
			
			#app {
				position: absolute;
				top: 54px;
				bottom: 2px;
				width: 100%;
			}
			
			#scroller {
				margin: 0;
				padding: 0;
			}
			
			.jroll-infinite-tip {
				height: 44px;
				line-height: 44px;
				text-align: center;
			}
			
			.jroll-vue-infinite {
				height: 100%;
			}

			background: radial-gradient(transparent 0, transparent 5px, #F39B00 5px);
			background-size: 15px 15px;
			background-position: 9px 3px;
			.demo {
				width: 96%;
				margin: 0 auto;
			}
			
			.stamp * {
				padding: 0;
				margin: 0;
				list-style: none;
				font-family: "Microsoft YaHei", 'Source Code Pro', Menlo, Consolas, Monaco, monospace;
			}
			
			.stamp {
				width: 100%;
				height: 140px;
				padding: 4px 10px;
				margin-bottom: 8px;
				position: relative;
				overflow: hidden;
			}
			
			.stamp:before {
				content: '';
				position: absolute;
				top: 0;
				bottom: 0;
				left: 10px;
				right: 10px;
				z-index: -1;
			}
			
			.stamp i {
				position: absolute;
				left: 20%;
				top: 45px;
				height: 190px;
				width: 390px;
				background-color: rgba(255, 255, 255, .15);
				transform: rotate(-30deg);
			}
			
			.stamp .par {
				float: left;
				padding: 16px 15px;
				width: 60%;
				border-right: 2px dashed rgba(255, 255, 255, .3);
				text-align: left;
			}
			
			.stamp .par p {
				color: #fff;
				font-size: 16px;
				line-height: 21px;
			}
			
			.stamp .par span {
				font-size: 32px;
				color: #fff;
				margin-right: 5px;
				line-height: 65px;
			}
			
			.stamp .par .sign {
				font-size: 32px;
			}
			
			.stamp .par sub {
				position: relative;
				top: -5px;
				color: rgba(255, 255, 255, .8);
			}
			
			.stamp .copy {
				display: inline-block;
				margin-left: 22px;
				padding: 21px 4px;
				width: 30%;
				vertical-align: text-bottom;
				font-size: 18px;
				color: rgb(255, 255, 255);
				text-align: center;
				line-height: initial;
			}
			
			.stamp .copy p {
				font-size: 16px;
				margin-top: 15px;
			}
			
			.stamp01 {
				background: radial-gradient(rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 5px, #F39B00 5px);
				background-size: 15px 15px;
				background-position: 9px 3px;
			}

			
			.stamp01:before {
				background-color: #F39B00;
			}
			
			.stamp01 .par a {
				width: 28px;
				background-color: #fff;
				color: #333;
				font-size: 14px;
				text-decoration: none;

				border-radius: 3px;

			}
			
			
			.stamp02 {
				background: radial-gradient(transparent 0, transparent 5px, #D24161 5px);
				background-size: 15px 15px;
				background-position: 9px 3px;
			}
			
			.stamp02:before {
				background-color: #D24161;
			}
			
			.stamp03 {
				background: radial-gradient(transparent 0, transparent 5px, #7EAB1E 5px);
				background-size: 15px 15px;
				background-position: 9px 3px;
			}
			
			.stamp03:before {
				background-color: #7EAB1E;
			}
			
			.stamp03 .copy {
				padding: 10px 6px 10px 12px;
				font-size: 24px;
			}
			
			.stamp03 .copy p {
				font-size: 14px;
				margin-top: 5px;
				margin-bottom: 8px;
			}
			
			.stamp03 .copy a {
				background-color: #fff;
				color: #333;
				font-size: 14px;
				text-decoration: none;
				padding: 5px 10px;
				border-radius: 3px;
				display: block;
			}
			
			.stamp04 {
				width: 390px;
				background: radial-gradient(rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 4px, #50ADD3 4px);
				background-size: 12px 8px;
				background-position: -5px 10px;
			}
			
			.stamp04:before {
				background-color: #50ADD3;
				left: 5px;
				right: 5px;
			}
			
			.stamp04 .copy {
				padding: 10px 6px 10px 12px;
				font-size: 24px;
			}
			
			.stamp04 .copy p {
				font-size: 14px;
				margin-top: 5px;
				margin-bottom: 8px;
			}
			
			.stamp04 .copy a {
				background-color: #fff;
				color: #333;
				font-size: 14px;
				text-decoration: none;
				padding: 5px 10px;
				border-radius: 3px;
				display: block;
			}
		</style>

	</head>

	<body>

		<div class="aui-page" id="bodyinfo" style="margin-top: 0px;">

			<!-- 导航切换 begin -->

			<div class="aui-tab t-line">
				<ul class="aui-b-border">
					<li class="aui-hit r-line" @click="showx(0)">可使用</li>
					<li class="r-line" @click="showx(1)">已使用</li>
					<li class="r-line" @click="showx(2)">已过期</li>
					<li class="r-line" @click="showx(3)">已赠送</li>
				</ul>
			</div>

			<!-- 效果1 begin -->

			<!-- 效果1 end -->

			<div class="aui-news-content" id="app">
				<jroll-infinite class="jroll-vue-infinite">
					<div class="demo">

						<div class="stamp stamp01" v-for="(Item,index) in ItemList">

							<div class="par" >
								<p>订单满{{Item.beMaxAmount}}元&nbsp;&nbsp;&nbsp;<a @click="sendUser(Item.ecouponId)" v-show="showtime==0">赠送</a></p><sub class="sign">￥</sub><span>{{Item.faceValue}}</span><sub>优惠券</sub>
								<p>NO.{{Item.couponCode}}</p>
							</div>
							<div class="copy">副券
								<p>{{Item.beginTime}}<br>{{Item.endTime}}</p>
								
							</div>

							<i></i>

						</div>

					</div>
				</jroll-infinite>
			</div>

			<!-- 导航切换 end -->

		</div>
		<script src="../js/lib/jquery-2.1.3.min.js"></script>
		<script src="../js/lib/hui.js" type="text/javascript"></script>
		<script src="../js/public.js" type="text/javascript"></script>
		<script src="../js/lib/vue20.min.js" type="text/javascript"></script>
		<script src="../js/lib/axios.min.js"></script>
		<script src="../js/lib/qs.js"></script>
		<script src="../js/lib/jroll.js" type="text/javascript"></script>
		<script src="../js/lib/jroll-vue-infinite.js" type="text/javascript"></script>
		<script src="../js/lib/jroll-pulldown.js" type="text/javascript"></script>
		<script>
			var domainUrl = GetMvcApiDomain();
			var mallDomainUrl = GetMallApiDomain();
			var username = null;
			var strWhere = "";
			var filedOrder = 'id';


function plusReady() { 
HeadShow();	
back();


var objuser=JSON.parse(plus.storage.getItem('user'));
username = objuser.UserName;






vum.state = 1;
vum.GetJrollItemList(); 

}

if(window.plus){  
plusReady();  
}else{  
document.addEventListener("plusready",plusReady,false);  
} 




			// vue实例
			var vum
			var infOptions = {

				bottomed: function(complete) {
					if(this.$parent.showtime == 0) {
						this.$parent.state = 1;
						this.$parent.GetJrollItemList();
					}
					if(this.$parent.showtime == 1) {
						this.$parent.state = 2;
						this.$parent.GetJrollItemList();
					}
					if(this.$parent.showtime == 2) {
						this.$parent.state = 3;
						this.$parent.GetJrollItemList();
					}
					if(this.$parent.showtime == 3) {
						this.$parent.state = 4;
						this.$parent.GetJrollItemList();
					}

				},
				updated: function() {
					console.log('current page is ' + this.page)
				}

			}

			vum = new Vue({
				el: '#bodyinfo',
				components: {
					'jroll-infinite': JRoll.VueInfinite(infOptions, {
						scrollBarY: true
					})
				},
				data: {
					pageIndex: 0,
					pageSize: 20,
					state: 1,
					showtime: 0,
					ItemData: [],
					ItemList: []
				},
				mounted: function() {

					this.$nextTick(function() {

					})

				},

				methods: {
					GetJrollItemList: function() {
						var that = this;
						//that.axiosGetLoadding();
						axios.get(mallDomainUrl + 'api/Ecoupon/getMyEcouponRecord', {
								params: {
									pageIndex: that.$children[0].page + 1,
									pageSize: that.pageSize,
									state: that.state,
									UserName: username,
									KeySearch: '',
								}
							})
							.then(function(response) {
								var jsonx = eval(response.data.RecordList);
								that.ItemData = [];
								each(jsonx, function(i, j) {
									that.ItemData.push({
										number: (i + 1),
										ecouponId: j.ecouponid,
										couponCode: j.couponCode,
										faceValue: j.faceValue,
										type: j.type,
										beginTime: j.beginTime,
										endTime: j.endTime,
										beMaxAmount: j.beMaxAmount,
										productUseValue: j.productUseValue,
										ecouponUseValue: j.ecouponUseValue,
									});

								});

								if(typeof complete === 'function') {
									that.ItemList = that.ItemData;
									hat.$children[0].complete();
								} else {
									that.ItemList = that.ItemList.concat(that.ItemData);
								}

								that.pageCount = response.data.PageCount;
								that.$children[0].total = response.data.PageCount;
								if(response.data.PageCount == 0) {
									that.$children[0].total = 1;
								} else {
									that.$children[0].total = response.data.PageCount;
								}
								that.$children[0].success();

							})
							.catch(function(response) {
								console.log(response);

							});
					},
                  GetJrollSendList: function() {
						var that = this;
						that.axiosGetLoadding();
						axios.get(mallDomainUrl + 'api/Ecoupon/getMyEcouponSendRecord', {
								params: {
									pageIndex: that.$children[0].page + 1,
									pageSize: that.pageSize,
									UserName: username,
									KeySearch: '',
								}
							})
							.then(function(response) {
								var jsonx = eval(response.data.RecordList);
								that.ItemData = [];
								each(jsonx, function(i, j) {
									that.ItemData.push({
										number: (i + 1),
										ecouponId: j.ecouponid,
										couponCode: j.couponCode,
										faceValue: j.faceValue,
										type: j.type,
										beginTime: j.beginTime,
										endTime: j.endTime,
										beMaxAmount: j.beMaxAmount,
										productUseValue: j.productUseValue,
										ecouponUseValue: j.ecouponUseValue,
									});

								});

								if(typeof complete === 'function') {
									that.ItemList = that.ItemData;
									hat.$children[0].complete();
								} else {
									that.ItemList = that.ItemList.concat(that.ItemData);
								}

								that.pageCount = response.data.PageCount;
								that.$children[0].total = response.data.PageCount;
								if(response.data.PageCount == 0) {
									that.$children[0].total = 1;
								} else {
									that.$children[0].total = response.data.PageCount;
								}
								that.$children[0].success();

							})
							.catch(function(response) {
								console.log(response);

							});
					},

					showx: function(x) {
						this.$children[0].scrollTop();
						this.pageIndex = 1;
						this.ItemList = [];
						this.ItemData = [];
						this.$children[0].page = 0;
						if(x == 0) {
							this.showtime = 0;
							this.state = 1;
							this.GetJrollItemList();
						}
						if(x == 1) {
							this.showtime = 1;
							this.state = 2;
							this.GetJrollItemList();
						}
						if(x == 2) {
							this.showtime = 2;
							this.state = 3;
							this.GetJrollItemList();
						}
						if(x == 3) {
							this.showtime = 4;
							this.state = 4;
							this.GetJrollSendList();
						}
					},

					sendUser: function(eid) {
						that=this;
						hui.prompt('请输入对方账号？', ['取消', '确定'], function(name) {
							that.PostSend(username,name,eid);
							//console.log('您输入了 :' + name);
						}, '例如 : 13800138000', '13800138000', function() {
							console.log('您点击了取消')
						});
					},
					
				PostSend: function(UserName, ToUser, EcouponId) {
					var that = this;

					axios.post(mallDomainUrl + 'api/Ecoupon/PostSendEcoupon', Qs.stringify({
							user_name: UserName,
							touser: ToUser,
							eid: EcouponId
						}))

						.then(function(response) {
							if(response.data.code == '200') {
								hui.upToast('操作成功');
								setTimeout(function() {
						this.$children[0].scrollTop();
						this.pageIndex = 1;
						this.ItemList = [];
						this.ItemData = [];
								that.showtime = 0;
							    that.state = 1;
							    that.GetJrollItemList();

								}, 800);

							} else {
								hui.upToast(response.data.msg);
								return false;
							}

						})
						.catch(function(response) {
							console.log(response);
						});

				},
					axiosGetLoadding: function() {
						axios.interceptors.request.use(function(config) {
							console.log('开始请求')
							config.headers['Content-Type'] = 'application/x-www-form-urlencoded';
							hui.loading('数据加载中');
							return config
						}, function(error) {
							console.log('请求失败')
							hui.closeLoading();
							hui.toast("数据加载失败,请检查网络");
							return Promise.reject(error)
						})
						axios.interceptors.response.use(function(config) {
							hui.closeLoading();

							console.log('接收响应')
							return config
						}, function(error) {
							console.log('响应出错')
							hui.closeLoading();
							hui.toast("数据加载失败,请检查网络");
							return Promise.reject(error)
						})
					},

				}

			})
		</script>

		<script type="text/javascript">
			$(function() {
				$('.aui-tab ul li').click(function() {
					$(this).addClass('aui-hit').siblings().removeClass('aui-hit');
					$('.aui-panes>div:eq(' + $(this).index() + ')').show().siblings().hide();
				})
			})
		</script>

	</body>

</html>